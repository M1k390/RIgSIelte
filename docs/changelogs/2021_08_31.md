# Versione 1.0

## Organizzazione della repository

- Organizzazione delle directories:
  - src: codice;
  - tests: unit tests;
  - data: file di configurazione, file per i test, file di systemd, ecc.;
  - docs: documentazione e changelogs;
  - patch: file di patch per librerie terze.
- Codice diviso in moduli:
  - *rigproc*: logica operativa;
  - *rigcam*: gestione delle fotocamere;
  - *rigboot*: gestione dell'avvio e dell'esecuzione di rigproc;
  - *rigman*: strumento di installazione e manutenzione.
- Parziale riorganizzazione del codice all'interno di *rigproc*.

## Distribuzione

- Pacchettizzazione del codice in un unico file eseguibile (per ciascun modulo software) tramite Pyinstaller.
- *rigproc*, *rigboot* e *rigcam* testati su Linux. *rigman* testato su Linux e Windows.
- Patch di confluent_kafka (modulo terzo per la comunicazione tramite Kafka in Python) per consentire la pacchettizzazione di *rigman* con Pyinstaller su Windows.
- Scripts per la pacchettizzazione tramite Pyinstaller nella root della repository:
  - [build_rigproc_rigcam.py](../../build_rigproc_rigcam.py);
  - [build_rigboot](../../build_rigboot.py);
  - [build_rigman](../../build_rigman.py) (applica automaticamente la patch citata al punto precedente).

## Software di gestione delle fotocamere

- Riscritto il software di gestione delle fotocamere in Python e rinominato [*rigcam*](../../src/rigcam/main.py).
- API Vimba aggiornate alla versione 4.2.
- Rilevamento di scatti multipli ravvicinati.
- Gestione efficiente della banda di rete sfruttando la cache interna delle fotocamere e scaricando le immagini da una fotocamera alla volta, o da un numero configurabile di fotocamere simultaneamente.
- Aggiornato [standard di comunicazione tra rigproc e rigcam](../rigcam.md) tramite Redis.
- Gestione della concorrenza nel codice tramite la combinazione di asyncio e threads Python.

## Software per l'avvio e il monitoraggio di rigproc

- Scritto nuovo software in Python ([*rigboot*](../../src/rigboot/rigboot.py)) per:
  - Avviare *rigproc*, cercando la versione indicata da un parametro in Redis;
  - Avvio di una versione di default in mancanza della versione più aggiornata;
  - Verifica del corretto avvio di *rigproc* tramite messaggio su Redis;
  - Monitoring di *rigproc* tramite heartbeat;
  - Riavvio del sistema quando richiesto da *rigproc* tramite messaggio di terminazione su Redis.
- Heartbeat e comportamento alla richiesta di riavvio configurabili.
- Compatibilità con file Python e file eseguibile.
- Indicazione dell'environment conda.

## Software di installazione e manutenzione

- Scritto nuovo software in Python ([*rigman*](../../src/rigman/main.py)) con le seguenti funzionalità:
  - Effettuare l’iscrizione del RIP presso l’STG;
  - Mostrare la configurazione di impianto in uso;
  - Ripristinare i parametri di configurazione ai valori contenuti nel file di configurazione;
  - Mostrare i parametri di stato dell’impianto più recenti;
  - Eseguire un’analisi diagnostica (checklist);
  - Ripristinare i parametri di stato dell’impianto ai valori di default;
  - Eseguire un test di comunicazione tra il RIP e l’impianto tramite bus seriale;
  - Mostrare la cronologia dei messaggi scambiati tra il RIP e l’impianto;
  - Inviare un messaggio all’impianto attraverso il bus seriale;
  - Verificare la corretta comunicazione con il RIP tramite Kafka;
  - Simulare l’STG e leggere tutti i messaggi inviati dal RIP tramite Kafka.
- Sviluppato [flow checklist](../../src/rigproc/flow/_flow_implant_status.py) e altre [funzionalità lato server](../../src/rigproc/console/handledata.py) a support di *rigman*.

## Protocolli di comunicazione

- Protocollo di comuncazione sul bus seriale 485 aggiornato alla versione 4.1 del 30 giugno 2021.
  - Aggiornati [iocomm](../../src/rigproc/io/iocomm.py), [ioanswers](../../src/rigproc/io/ioanswers.py), [iogrammar](../../src/rigproc/io/iogrammar.py) e [fakebus](../../src/rigproc/fake_modules/fakebus.py).
- Protocollo di comunicazione tramite Kafka con l'STG aggiornato alla versione 1.2 del 27 maggio 2021.
  - Topic aggiunti:
    - AllarmeAnomaliaIVIP;
    - AggiornamentoFinestraInizioTratta_STGtoRIP;
    - AggiornamentoFinestraInizioTratta_RIPtoSTG;
    - AggiornamentoSW_STGtoRIP;
    - AggiornamentoSW_RIPtoSTG;
    - IscrizioneRip_RIPtoSTG.
  - Aggiornato [jsonmodel](../../src/rigproc/commons/jsonmodel.py).

## Aggiornamento impostazioni interne

- Aggiornamento delle seguenti impostazioni del programma da parte dell'STG tramite messaggio Kafka:
  - t_mosf_prrA;
  - t_mosf_prrB;
  - t_off_ivip_prrA;
  - t_off_ivip_prrB;
  - finestra_temp_pic_pari;
  - finestra_temp_pic_dispari.

## Aggiornamento software

- Riavvio del sistema all'orario prestabilito e avvio della versione aggiornata del software alla sessione successiva, tramite la coordinazione tra rigproc e rigboot.

## Rilevamento anomalie

- Stato dei componenti loggato in Redis persistent con delle chiavi con un prefisso costante.
- Rilevamento delle anomalie tramite un subscriber di Redis.
- Segnalazione delle anomalie all'STG tramite Kafka.
- Lista delle anomalie consultabile in [anomalies.py](../../src/rigproc/params/anomalies.py).
- Rilevamento periodico della raggiungibilità delle risorse remote (camere, server Kafka, server sshfs) tramite [periodic_pinger](../../src/rigproc/central/periodic_pinger.py).

## Logging

- Aggiornata gestione del [logger](../../src/rigproc/commons/logger.py).
- Aggiunti i colori al logging via console per la distinzione di diversi tipi di messaggi (errori, warnings...) configurabile. I colori non sono visibili nel file di log.
  - Colori specifici per alcuni messaggi dei flow.
  - Colori specifici per alcuni messaggi di rigcam.
- Configurazione dei colori tramite l'opzione "formatter":
  - color: colori classici;
  - alt: colori speciali per i flow;
  - entity: colori speciali per rigcam;
  - *altro...* (generico, senza colori, non utilizzato).

## Parsing del file di configurazione

- Aggiunta gestione del file di configurazione tramite [config.py](../../src/rigproc/commons/config.py).
- Verifica correttezza del file di configurazione e segnalazione anomalia:
  - Verifica della presenza di tutte le chiavi programmate;
  - Verifica del tipo di dato per alcuni parametri;
  - Verifica appartenenza ad un insieme di valori programmati per alcuni parametri.
- Sincronizzazione di alcuni parametri (di impianto) con Redis persistent.
  - Lettura e impostazione dei valori presenti in Redis ad ogni sessione.
- Possibilità di reset ai valori presenti nel file di configurazione.
- Accesso al manager della configurazione tramite singleton.

## Flow

- Riscrittura parziale del codice dei [Flow](../../src/rigproc/flow/flow.py):
  - [flow camera event](../../tests/flow/test_flow_camera_event.py) (ex flow trig);
  - [flow diagnosis](../../src/rigproc/flow/flow_diagnosis.py);
  - [flow recovery](../../src/rigproc/flow/flow_recovery.py).
- Gestione dei loop nei task del flow.
- Thread dedicato a ciascun flow per evitare blocchi nell'esecuzione del programma.
- Altri flow utilizzano ancora l'implementazione precedente.

## Recovery

- Riscrittura del codice del [Recovery](../../src/rigproc/central/recovery_manager.py).
- Invio della richiesta del flow recovery al main process.
- Notifica dell'esito del recovery da parte del flow recovery.
- Rimosso monitoraggio della percentuale di completamento del flow recovery.

## Dati MOSF di altezza filo

- Trimming dei dati di altezza filo ricevuti dal MOSF in base al parametro di configurazione.
- Ritardo nella richiesta dei dati al MOSF, di un valore di tempo configurabile, per garantire la ricezione dei dati più aggiornati e pertinenti con l'evento di passaggio treno.

## Riordino parziale delle chiavi

- Spostamento delle chiavi da [keywords](../../src/rigproc/commons/keywords.py) a params.
- Organizzazione delle chiavi in categorie:
  - [anomalies](../../src/rigproc/params/anomalies.py);
  - [bus](../../src/rigproc/params/bus.py);
  - [cli](../../src/rigman/cli.py);
  - [conf_values](../../src/rigproc/params/conf_values.py);
  - [general](../../src/rigproc/params/general.py);
  - [internal](../../src/rigproc/params/internal.py);
  - [kafka](../../src/rigproc/params/kafka.py);
  - [redis_keys](../../src/rigproc/params/redis_keys.py).
- Organizzazione delle chiavi in gruppi all'interno di ciascuna categoria.
- Parziale spostamento dei riferimenti nel codice da keywords a params.

## Redis

- Riorganizzazione codice in [redisi.py](../../src/rigproc/commons/redisi.py):
  - Wrapping delle operazioni sulla cache di Redis per catturare eventali eccezioni;
  - Rinominato RedisI in DualRedis (cache + persistent);
  - Aggiunti metodi specifici per ciascuna operazione utile su Redis: nel codice non vengono mai fatte operazioni dirette sulla cache, ma vengono chiamati questi metodi, salvo rari casi particolari.
  - Accesso al manager di Redis tramite singleton.

## Codice di supporto

- Aggiunti svariati metordi a [helper.py](../../src/rigproc/commons/helper.py), tra cui funzioni per la gestione dei file e degli archivi zip, gestione delle strutture json, formattazione del testo e gestione dei timestamps.
- Aggiunti wrapper delle operazioni sui dict per catturare eventuali eccezioni.

## Versionamento

- Aggiunta versione del software con riferimento nel codice in [version.py](../../src/rigproc/version.py).
- Lettura della versione in [setup.py](../../setup.py).

## File di configurazione

- Aggiornata la struttura del file di configurazione per riflettere le altre modifiche.
- Le configurazioni di esempio disponibili in data sono state rinominate in accordo con la seguente [legenda](../../data/conf_legenda).
- Le impostazioni di logging sono state unificate.
- Qualsiasi modifica alla struttura della configurazione richiede ora la modifica congiunta di [config.py](../../src/rigproc/commons/config.py).

## Unit tests

- Eliminazione test obsoleti.
- Aggiunta di nuovi test:
  - [test_helper](../../tests/commons/test_helper.py);
  - [test_config](../../tests/config/test_config.py);
  - [test_flow_camera_event](../../tests/flow/test_flow_camera_event.py);
  - [test_kafka_models](../../tests/kafka_models/test_kafka_models.py);
  - [test_anomalies](../../tests/params/test_anomalies.py);
  - [test_params](../../tests/params/test_params.py);
  - [test_recovery](../../tests/recovery/test_recovery.py);
  - [test_redis](../../tests/redis/test_redis.py);
  - [test_wrappers](../../tests/wrappers/test_wrappers.py).
